<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COTIZADOR IFS - Mapa Interactivo con M√∫ltiples Entregas</title>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- Turf.js para c√°lculos de distancia -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    
    <!-- Axios para peticiones HTTP -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- XLSX para exportar Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .logo {
            height: 70px;
        }
        
        .header h1 {
            color: #003366;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header-subtitle {
            color: #666;
            font-size: 16px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* PANEL IZQUIERDO - FORMULARIO */
        .form-panel {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .form-section h3 {
            color: #003366;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        /* PANEL DERECHO - MAPA Y RESULTADOS */
        .map-results-container {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
        }
        
        /* MAPA */
        .map-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            height: 500px;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }
        
        .map-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .map-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .map-btn:hover {
            background: #0056b3;
        }
        
        /* RESULTADOS */
        .results-panel {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .price-display {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            min-width: 200px;
        }
        
        .price-amount {
            font-size: 32px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .cost-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .cost-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .cost-card h4 {
            color: #003366;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .cost-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        /* TABLAS DE VI√ÅTICOS */
        .table-viaticos {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .table-viaticos th {
            background: #e9ecef;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .table-viaticos td {
            padding: 8px;
            border: 1px solid #dee2e6;
        }
        
        .table-viaticos tfoot td {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        /* BOTONES */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,123,255,0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
            color: white;
        }
        
        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        /* DESTINOS DIN√ÅMICOS */
        .destino-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #dc3545;
        }
        
        .destino-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .destino-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .destino-controls {
            display: flex;
            gap: 5px;
        }
        
        .destino-controls button {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .tiempo-despacho-input {
            width: 100px !important;
            padding: 8px !important;
            margin-left: 10px;
        }
        
        /* HISTORIAL */
        .history-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        th {
            background: #003366;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* ALERTAS */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* LOADING */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* PORCENTAJE DE CARGA */
        .casilla-porcentaje {
            display: inline-block;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #f5f5f5;
            font-weight: bold;
            font-size: 14px;
            color: #222;
            min-width: 100px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .casilla-porcentaje.bajo {
            background: #28a745;
            color: #fff;
            border-color: #1e7e34;
        }
        
        .casilla-porcentaje.medio {
            background: #ffc107;
            color: #212529;
            border-color: #e0a800;
        }
        
        .casilla-porcentaje.alto {
            background: #dc3545;
            color: #fff;
            border-color: #bd2130;
        }
        
        /* CONTROL DE VELOCIDAD */
        .velocidad-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .toggle-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .toggle-btn.active {
            background: #007bff;
        }
        
        /* MONTO DEL TRANSPORTE */
        .monto-transporte {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .monto-transporte h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .monto-display {
            font-size: 24px;
            font-weight: bold;
            color: #d39e00;
            text-align: center;
            margin: 10px 0;
        }
        
        /* WHATSAPP PERSONALIZADO */
        .custom-whatsapp {
            margin-top: 20px;
            padding: 20px;
            background: #e8f4fd;
            border-radius: 8px;
            border-left: 4px solid #25D366;
        }
        
        .custom-whatsapp textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 10px;
            resize: vertical;
            min-height: 100px;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-panel {
                position: static;
                max-height: none;
            }
            
            .cost-details {
                grid-template-columns: 1fr;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 14px;
                min-width: 120px;
            }
            
            .price-display {
                min-width: auto;
                padding: 10px 15px;
            }
            
            .price-amount {
                font-size: 24px;
            }
            
            .map-controls {
                flex-direction: column;
                right: 10px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn-group button {
                width: 100%;
            }
        }
    </style>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- ENCABEZADO -->
        <div class="header">
            <div class="logo-container">
                <i class="fas fa-truck-moving" style="font-size: 40px; color: #003366;"></i>
                <div>
                    <h1><i class="fas fa-map-marked-alt"></i> COTIZADOR IFS CON MAPA</h1>
                    <div class="header-subtitle">Trazabilidad en vivo de rutas con m√∫ltiples entregas - International Freight Services Panam√°</div>
                </div>
            </div>
            <div style="margin-top: 15px; color: #666; font-size: 14px;">
                <i class="fas fa-phone"></i> (+507) 271-6300 | 
                <i class="fas fa-envelope"></i> info@ifs-panama.com
            </div>
            <div class="numero-cotizacion-box" id="numeroCotizacion" style="margin-top: 10px; font-size: 16px;">COT-20250206-TRA-1000</div>
        </div>
        
        <!-- CONTENIDO PRINCIPAL -->
        <div class="main-grid">
            <!-- PANEL IZQUIERDO: FORMULARIO -->
            <div class="form-panel">
                <div class="form-section">
                    <h3><i class="fas fa-user"></i> DATOS DEL CLIENTE</h3>
                    <div class="form-group">
                        <label for="cliente"><i class="fas fa-building"></i> Nombre del Cliente *</label>
                        <input type="text" id="cliente" class="form-control" placeholder="Ej: Empresa ABC S.A." required>
                    </div>
                    <div class="form-group">
                        <label for="contacto"><i class="fas fa-phone"></i> Contacto / Tel√©fono</label>
                        <input type="text" id="contacto" class="form-control" placeholder="Ej: Juan P√©rez - 6000-0000">
                    </div>
                    <div class="form-group">
                        <label for="codigoArea"><i class="fas fa-building"></i> C√≥digo de √Årea</label>
                        <select id="codigoArea" class="form-control" onchange="actualizarNumeroCotizacion()">
                            <option value="">-- Seleccione --</option>
                            <option value="OPL">OPL</option>
                            <option value="TR">TR</option>
                            <option value="COM">COM</option>
                            <option value="GCIA">GCIA</option>
                            <option value="TRA" selected>TRA</option>
                            <option value="CEO">CEO</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-route"></i> RUTA EN EL MAPA</h3>
                    <div class="form-group">
                        <label for="origen"><i class="fas fa-map-marker-alt" style="color: #28a745;"></i> Punto de Origen *</label>
                        <input type="text" id="origen" class="form-control" placeholder="Ej: Ciudad de Panam√°" value="Ciudad de Panam√°" required>
                    </div>
                    
                    <!-- DESTINOS DIN√ÅMICOS -->
                    <div id="destinosContainer">
                        <div class="destino-item" id="destino1-container">
                            <div class="destino-item-header">
                                <div class="destino-number">1</div>
                                <div class="destino-controls">
                                    <button onclick="eliminarDestino(1)" class="btn-danger" style="padding: 5px 10px; font-size: 12px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-map-marker-alt" style="color: #dc3545;"></i> Destino 1 *</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="destino1" class="form-control destino-input" placeholder="Ej: David, Chiriqu√≠" required>
                                    <input type="number" class="tiempo-despacho-input" id="tiempoDespacho1" min="5" step="5" value="15" placeholder="Min" title="Tiempo de despacho (minutos)">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="agregarDestino()" class="btn btn-warning" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-plus"></i> AGREGAR DESTINO
                    </button>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-box"></i> TIPO DE CARGA</h3>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="carga_import" value="import">
                            <label for="carga_import">Import</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carga_export" value="export">
                            <label for="carga_export">Export</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carga_aereo" value="aereo">
                            <label for="carga_aereo">A√©reo</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carga_contenedor" value="contenedor">
                            <label for="carga_contenedor">Contenedor</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carga_transporte-local" value="transporte-local">
                            <label for="carga_transporte-local">Transporte Local</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carga_carga-suelta" value="carga-suelta">
                            <label for="carga_carga-suelta">Carga Suelta</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="carga_consolidada" value="consolidada">
                            <label for="carga_consolidada">Consolidada</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-truck"></i> VEH√çCULO Y CARGA</h3>
                    <div class="form-group">
                        <label for="vehiculo"><i class="fas fa-car"></i> Tipo de Veh√≠culo *</label>
                        <select id="vehiculo" class="form-control" required onchange="actualizarVelocidadVehiculo(); calcularPorcentajeCarga();">
                            <option value="">-- Seleccione --</option>
                            <option value="MOTO">üõµ Moto</option>
                            <option value="AUTO">üöó Auto / Sed√°n</option>
                            <option value="PKUP">üõª Pick-Up</option>
                            <option value="PANEL">üöê Panel / Van</option>
                            <option value="CF14" selected>üöõ Cami√≥n F-14</option>
                            <option value="CF16">üöõ Cami√≥n F-16</option>
                            <option value="CF26">üöõ Cami√≥n F-26</option>
                            <option value="CF20">üöõ Cami√≥n C-20</option>
                            <option value="MC24">üöúüöõ Mula 20/40</option>
                            <option value="MSXT">üöúüöõ Mula XT sobre dimensi√≥n</option>
                            <option value="MS40">üöúüöõ Mula con mesa</option>
                            <option value="CB60">üöúüöõ Mula cama baja 60 T</option>
                            <option value="CPLT">üöõ Cami√≥n Platform</option>
                            <option value="GRBK">üöõüîÑ Cami√≥n Gr√∫a Roll</option>
                            <option value="GALT">üèóÔ∏è Gr√∫a Boom Altec</option>
                            <option value="GPFG">üèóÔ∏è Gr√∫a Palfinger</option>
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label for="peso"><i class="fas fa-weight-hanging"></i> Peso (kg)</label>
                            <input type="number" id="peso" class="form-control" value="0" min="0" step="1" oninput="calcularPorcentajeCarga()">
                        </div>
                        <div class="form-group">
                            <label for="volumen"><i class="fas fa-cube"></i> Volumen (m¬≥)</label>
                            <input type="number" id="volumen" class="form-control" value="0" min="0" step="0.01" oninput="calcularPorcentajeCarga()">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-percentage"></i> % Peso / % Volumen</label>
                        <div id="porcentajeCargaTexto" class="casilla-porcentaje">‚Äì / ‚Äì</div>
                    </div>
                    
                    <div style="font-size: 14px; color: #666; margin-top: 10px;">
                        <i class="fas fa-tachometer-alt"></i> Velocidad promedio: <span id="velocidadTexto" style="font-weight: bold;">16 km/h</span> |
                        <i class="fas fa-weight"></i> Peso √∫til: <span id="pesoVehiculoTexto" style="font-weight: bold;">2,980 kg</span> |
                        <i class="fas fa-cube"></i> Volumen: <span id="volumenVehiculoTexto" style="font-weight: bold;">18.22 m¬≥</span>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-utensils"></i> VI√ÅTICOS Y PERNOCTA</h3>
                    
                    <table class="table-viaticos">
                        <thead>
                            <tr>
                                <th>Concepto</th>
                                <th style="width: 80px;">¬øAplica?</th>
                                <th style="width: 80px;">Cantidad</th>
                                <th style="width: 80px;">USD/u</th>
                                <th style="width: 100px;">Sub-total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Desayuno</td>
                                <td style="text-align: center;"><input type="checkbox" id="chkDesayuno" onchange="calcViaticos()"></td>
                                <td><input type="number" id="qtyDesayuno" min="0" value="1" style="width: 60px; padding: 4px;" oninput="calcViaticos()"></td>
                                <td>5.00</td>
                                <td id="subDesayuno">0.00</td>
                            </tr>
                            <tr>
                                <td>Almuerzo</td>
                                <td style="text-align: center;"><input type="checkbox" id="chkAlmuerzo" onchange="calcViaticos()"></td>
                                <td><input type="number" id="qtyAlmuerzo" min="0" value="1" style="width: 60px; padding: 4px;" oninput="calcViaticos()"></td>
                                <td>8.00</td>
                                <td id="subAlmuerzo">0.00</td>
                            </tr>
                            <tr>
                                <td>Cena</td>
                                <td style="text-align: center;"><input type="checkbox" id="chkCena" onchange="calcViaticos()"></td>
                                <td><input type="number" id="qtyCena" min="0" value="1" style="width: 60px; padding: 4px;" oninput="calcViaticos()"></td>
                                <td>7.00</td>
                                <td id="subCena">0.00</td>
                            </tr>
                            <tr>
                                <td>Hotel noche</td>
                                <td style="text-align: center;"><input type="checkbox" id="chkHotel" onchange="calcViaticos()"></td>
                                <td><input type="number" id="qtyHotel" min="0" value="1" style="width: 60px; padding: 4px;" oninput="calcViaticos()"></td>
                                <td>45.00</td>
                                <td id="subHotel">0.00</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right; font-weight: bold;">TOTAL VI√ÅTICOS + HOSPEDAJE</td>
                                <td id="totalViaticos" style="font-weight: bold;">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <!-- Campos ocultos para almacenar valores -->
                    <input type="hidden" id="viaticos" value="0">
                    <input type="hidden" id="hospedaje" value="0">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="horasExtras"><i class="fas fa-clock"></i> Horas extras (h)</label>
                            <input type="number" id="horasExtras" class="form-control" value="0" min="0" step="0.1" oninput="autoRecalcular()">
                        </div>
                        <div class="form-group">
                            <label for="tiempoCargaDescarga"><i class="fas fa-hourglass-half"></i> Tiempo carga/descarga (h)</label>
                            <input type="number" id="tiempoCargaDescarga" class="form-control" value="1.12" min="0" step="0.01" oninput="autoRecalcular()">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-dollar-sign"></i> COSTOS ADICIONALES</h3>
                    
                    <!-- Control de Velocidad -->
                    <div class="velocidad-control">
                        <button type="button" class="toggle-btn" onclick="toggleVelocidadPersonalizada()" id="btnToggleVelocidad">
                            üö¶ Velocidad manual: OFF
                        </button>
                        
                        <div id="veloPersWrapper" style="display: none; flex: 1;">
                            <label for="velocidadPersonal" style="font-size: 14px;">Velocidad (km/h):</label>
                            <input type="number" id="velocidadPersonal" class="form-control" value="30" min="5" max="120" step="5" 
                                   style="width: 100px; display: inline-block; margin-left: 10px;" oninput="autoRecalcular()">
                        </div>
                        <input type="checkbox" id="checkVeloPers" style="display: none;">
                    </div>
                    
                    <!-- Control de Peajes -->
                    <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                        <button type="button" class="toggle-btn" onclick="toggleEvitarPeaje()" id="btnTogglePeaje">
                            üõ£Ô∏è Sin peajes: ON
                        </button>
                        
                        <div style="flex: 1;">
                            <label for="peajes" style="font-size: 14px;">Costo de peajes (USD):</label>
                            <input type="number" id="peajes" class="form-control" value="0" min="0" step="0.01" 
                                   style="width: 120px; display: inline-block; margin-left: 10px;" oninput="autoRecalcular()">
                        </div>
                        <input type="checkbox" id="evitarPeajes" checked style="display: none;">
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="combustible"><i class="fas fa-gas-pump"></i> Precio Combustible (USD/litro)</label>
                        <input type="number" id="combustible" class="form-control" value="0.85" min="0" step="0.01" oninput="autoRecalcular()">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-money-bill-wave"></i> MONTO DEL TRANSPORTE</h3>
                    <div class="monto-transporte">
                        <h4><i class="fas fa-truck-loading"></i> Monto del Transporte</h4>
                        <div class="monto-display" id="montoTransporte">US$ 0.00</div>
                        <label for="inputMontoTransporte" style="font-size: 14px;">Ingresar monto manualmente (USD):</label>
                        <input type="number" id="inputMontoTransporte" class="form-control" value="0.00" step="0.01" 
                               style="margin-top: 5px;" oninput="actualizarMontoTransporte()">
                    </div>
                </div>
                
                <!-- BOTONES DE ACCI√ìN -->
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="calcularRuta()" id="btnCalcular">
                        <i class="fas fa-map-marked-alt"></i> TRAZAR RUTA
                    </button>
                    <button class="btn btn-success" onclick="guardarCotizacion()" id="btnGuardar" disabled>
                        <i class="fas fa-save"></i> GUARDAR
                    </button>
                    <button class="btn btn-warning" onclick="limpiarFormulario()">
                        <i class="fas fa-broom"></i> LIMPIAR
                    </button>
                </div>
            </div>
            
            <!-- PANEL DERECHO: MAPA Y RESULTADOS -->
            <div class="map-results-container">
                <!-- MAPA INTERACTIVO -->
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-controls">
                        <button class="map-btn" onclick="centrarMapa()" title="Centrar mapa">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <button class="map-btn" onclick="limpiarRuta()" title="Limpiar ruta">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="map-btn" onclick="alternarSatelite()" title="Vista sat√©lite">
                            <i class="fas fa-satellite"></i>
                        </button>
                        <button class="map-btn" onclick="centrarEnOrigen()" title="Centrar en origen">
                            <i class="fas fa-map-marker-alt" style="color: #28a745;"></i>
                        </button>
                        <button class="map-btn" onclick="mostrarDistancias()" title="Mostrar distancias">
                            <i class="fas fa-ruler"></i>
                        </button>
                    </div>
                </div>
                
                <!-- RESULTADOS DE COTIZACI√ìN -->
                <div class="results-panel">
                    <div class="results-header">
                        <h3 style="color: #003366; margin: 0;">
                            <i class="fas fa-file-invoice-dollar"></i> COTIZACI√ìN DETALLADA
                        </h3>
                        <div class="price-display" id="priceDisplay" style="display: none;">
                            <div style="font-size: 12px; opacity: 0.9;">PRECIO SUGERIDO</div>
                            <div class="price-amount" id="precioSugerido">$0.00</div>
                            <div style="font-size: 12px;">(30% markup)</div>
                        </div>
                    </div>
                    
                    <div id="resultadosDetalles">
                        <div style="text-align: center; padding: 30px; color: #6c757d;">
                            <i class="fas fa-route" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                            <h4>Complete la ruta y haga clic en "TRAZAR RUTA"</h4>
                            <p>El mapa mostrar√° la ruta completa con distancias y tiempos</p>
                        </div>
                    </div>
                    
                    <!-- INFORMACI√ìN DE LA RUTA -->
                    <div id="rutaInfo" style="display: none;">
                        <div class="cost-details">
                            <div class="cost-card">
                                <h4><i class="fas fa-road"></i> DISTANCIA TOTAL</h4>
                                <div class="cost-value" id="distanciaTotal">0 km</div>
                            </div>
                            <div class="cost-card">
                                <h4><i class="fas fa-clock"></i> TIEMPO ESTIMADO</h4>
                                <div class="cost-value" id="tiempoTotal">0 min</div>
                            </div>
                            <div class="cost-card">
                                <h4><i class="fas fa-gas-pump"></i> COMBUSTIBLE</h4>
                                <div class="cost-value" id="costoCombustible">$0.00</div>
                            </div>
                            <div class="cost-card">
                                <h4><i class="fas fa-utensils"></i> VI√ÅTICOS+HOTEL</h4>
                                <div class="cost-value" id="costoViaticosHotel">$0.00</div>
                            </div>
                        </div>
                        
                        <div class="cost-details">
                            <div class="cost-card">
                                <h4><i class="fas fa-user-tie"></i> PERSONAL</h4>
                                <div class="cost-value" id="costoPersonal">$0.00</div>
                            </div>
                            <div class="cost-card">
                                <h4><i class="fas fa-tools"></i> DESPACHO</h4>
                                <div class="cost-value" id="costoDespacho">$0.00</div>
                            </div>
                            <div class="cost-card">
                                <h4><i class="fas fa-road"></i> PEAJES</h4>
                                <div class="cost-value" id="costoPeajes">$0.00</div>
                            </div>
                            <div class="cost-card">
                                <h4><i class="fas fa-calculator"></i> COSTO BASE</h4>
                                <div class="cost-value" id="costoBase">$0.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- WHATSAPP PERSONALIZADO -->
                    <div class="custom-whatsapp" id="customMsgBox" style="display: none;">
                        <h4><i class="fab fa-whatsapp"></i> MENSAJE PERSONALIZADO PARA WHATSAPP</h4>
                        <textarea id="customWhatsAppText" placeholder="Personaliza el mensaje que se enviar√° por WhatsApp..."></textarea>
                        <div class="btn-group" style="margin-top: 15px;">
                            <button class="btn btn-whatsapp" onclick="enviarWhatsAppCustom()">
                                <i class="fab fa-whatsapp"></i> ENVIAR POR WHATSAPP
                            </button>
                            <button class="btn btn-success" onclick="copiarMensajeCustom()">
                                <i class="fas fa-copy"></i> COPIAR MENSAJE
                            </button>
                        </div>
                    </div>
                    
                    <!-- BOTONES DE EXPORTACI√ìN -->
                    <div class="btn-group" style="justify-content: center; margin-top: 30px;">
                        <button class="btn btn-danger" onclick="imprimirCotizacion()" id="btnImprimir" disabled>
                            <i class="fas fa-print"></i> IMPRIMIR COTIZACI√ìN
                        </button>
                        <button class="btn btn-primary" onclick="descargarRuta()" id="btnDescargar" disabled>
                            <i class="fas fa-download"></i> DESCARGAR RUTA
                        </button>
                        <button class="btn btn-whatsapp" onclick="enviarWhatsApp()" id="btnWhatsApp" disabled>
                            <i class="fab fa-whatsapp"></i> WHATSAPP R√ÅPIDO
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- HISTORIAL DE COTIZACIONES -->
        <div class="history-section">
            <h3 style="color: #003366; margin-bottom: 20px;">
                <i class="fas fa-history"></i> HISTORIAL DE COTIZACIONES
            </h3>
            
            <div class="btn-group" style="justify-content: flex-start;">
                <button class="btn btn-primary" onclick="cargarHistorial()">
                    <i class="fas fa-sync"></i> ACTUALIZAR HISTORIAL
                </button>
                <button class="btn btn-success" onclick="exportarExcel()">
                    <i class="fas fa-file-excel"></i> EXPORTAR A EXCEL
                </button>
                <button class="btn btn-warning" onclick="mostrarTodasRutas()">
                    <i class="fas fa-layer-group"></i> VER TODAS LAS RUTAS
                </button>
                <button class="btn btn-danger" onclick="limpiarHistorialConfirm()">
                    <i class="fas fa-trash"></i> LIMPIAR HISTORIAL
                </button>
            </div>
            
            <div style="margin: 15px 0;">
                <input type="text" id="filtroHistorial" class="form-control" placeholder="Buscar por cliente, veh√≠culo, fecha..." 
                       onkeyup="filtrarHistorial()" style="max-width: 400px;">
            </div>
            
            <div class="table-container">
                <table id="tablaHistorial">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>N√∫mero</th>
                            <th>Cliente</th>
                            <th>Origen</th>
                            <th>Destinos</th>
                            <th>Veh√≠culo</th>
                            <th>Tipo Carga</th>
                            <th>Dist (km)</th>
                            <th>Tiempo (min)</th>
                            <th>V+H ($)</th>
                            <th>Comb ($)</th>
                            <th>Personal ($)</th>
                            <th>Peaje ($)</th>
                            <th>Base ($)</th>
                            <th>+25% ($)</th>
                            <th>+35% ($)</th>
                            <th>+40% ($)</th>
                            <th>Monto Transp.</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="historialBody">
                        <!-- Los datos se cargan aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // ==================== VARIABLES GLOBALES ====================
        let map;
        let routingControl;
        let markers = [];
        let waypoints = [];
        let currentRouteInfo = null;
        let cotizacionActual = null;
        let historial = [];
        let autoRecalcularTimeout;
        let alerta70Mostrada = false;
        
        // Configuraci√≥n de veh√≠culos
        const VEHICULOS = {
            MOTO: { nombre: "Moto", velocidad: 29, consumo: 12, pesoMax: 25, volumenMax: 0.04, costoHora: 10, grupo: "moto" },
            AUTO: { nombre: "Auto / Sed√°n", velocidad: 21, consumo: 4.69, pesoMax: 120, volumenMax: 0.64, costoHora: 15, grupo: "liviano" },
            PKUP: { nombre: "Pick-Up", velocidad: 21, consumo: 4.31, pesoMax: 880, volumenMax: 3.17, costoHora: 18, grupo: "liviano" },
            PANEL: { nombre: "Panel / Van", velocidad: 21, consumo: 4.61, pesoMax: 920, volumenMax: 4.69, costoHora: 20, grupo: "liviano" },
            CF14: { nombre: "Cami√≥n F-14", velocidad: 16, consumo: 3.38, pesoMax: 2980, volumenMax: 18.22, costoHora: 25, grupo: "pesado" },
            CF16: { nombre: "Cami√≥n F-16", velocidad: 16, consumo: 3.06, pesoMax: 3720, volumenMax: 25.56, costoHora: 28, grupo: "pesado" },
            CF26: { nombre: "Cami√≥n F-26", velocidad: 12, consumo: 2.27, pesoMax: 5980, volumenMax: 46.27, costoHora: 32, grupo: "pesado" },
            CF20: { nombre: "Cami√≥n C-20", velocidad: 12, consumo: 2.35, pesoMax: 18000, volumenMax: 34.18, costoHora: 35, grupo: "pesado" },
            MC24: { nombre: "Mula 20/40", velocidad: 12, consumo: 1.9, pesoMax: 30000, volumenMax: 68.94, costoHora: 40, grupo: "mula" },
            MSXT: { nombre: "Mula XT sobre dimensi√≥n", velocidad: 12, consumo: 1.82, pesoMax: 54450, volumenMax: 81.49, costoHora: 45, grupo: "mula" },
            MS40: { nombre: "Mula con mesa", velocidad: 12, consumo: 1.82, pesoMax: 30000, volumenMax: 81.49, costoHora: 45, grupo: "mula" },
            CB60: { nombre: "Mula cama baja 60 T", velocidad: 12, consumo: 1.8, pesoMax: 54450, volumenMax: 142.90, costoHora: 50, grupo: "mula" },
            CPLT: { nombre: "Cami√≥n Platform", velocidad: 12, consumo: 2.21, pesoMax: 10000, volumenMax: 34.05, costoHora: 30, grupo: "pesado" },
            GRBK: { nombre: "Cami√≥n Gr√∫a Roll", velocidad: 12, consumo: 2.27, pesoMax: 14000, volumenMax: 34.05, costoHora: 35, grupo: "pesado" },
            GALT: { nombre: "Gr√∫a Boom Altec", velocidad: 12, consumo: 2.09, pesoMax: 14000, volumenMax: 34.05, costoHora: 40, grupo: "pesado" },
            GPFG: { nombre: "Gr√∫a Palfinger", velocidad: 12, consumo: 2.21, pesoMax: 14000, volumenMax: 34.05, costoHora: 40, grupo: "pesado" }
        };

        // Factores de ajuste
        const factoresTiempo = { MOTO: 1, AUTO: 1, PANEL: 1.05, PKUP: 1.05, CF14: 1.1, CF16: 1.1, CF26: 1.15, CF20: 1.15, MC24: 1.2, MSXT: 1.25, MS40: 1.25, CB60: 1.3, CPLT: 1.1, GRBK: 1.15, GALT: 1.1, GPFG: 1.1 };
        const factoresCarga = { import: 1, export: 1, aereo: 1.05, 'transporte-local': 1, 'carga-suelta': 1.05, consolidada: 1.05, contenedor: 1.1 };
        const velocidadesPorTipo = {
            moto: { motorway: 65, trunk: 55, primary: 50, secondary: 40, tertiary: 30, residential: 20, unclassified: 15, track: 15 },
            liviano: { motorway: 65, trunk: 55, primary: 50, secondary: 40, tertiary: 30, residential: 20, unclassified: 15, track: 15 },
            pesado: { motorway: 50, trunk: 40, primary: 30, secondary: 20, tertiary: 15, residential: 15, unclassified: 15, track: 15 },
            mula: { motorway: 45, trunk: 40, primary: 30, secondary: 20, tertiary: 20, residential: 20, unclassified: 15, track: 15 }
        };

        // Precios vi√°ticos
        const prices = { desayuno: 5, almuerzo: 8, cena: 7, hotel: 45 };

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar mapa
            inicializarMapa();
            
            // Cargar historial
            cargarHistorial();
            
            // Actualizar n√∫mero de cotizaci√≥n
            actualizarNumeroCotizacion();
            
            // Calcular vi√°ticos iniciales
            calcViaticos();
            
            // Configurar eventos para auto-recalcular
            configurarAutoRecalcular();
            
            // Mostrar mensaje de bienvenida
            setTimeout(() => {
                mostrarAlerta('¬°Bienvenido al Cotizador IFS con Mapa Interactivo! Complete los datos y haga clic en "TRAZAR RUTA"', 'success');
            }, 1000);
            
            // Configurar ejemplo de datos para prueba r√°pida
            document.getElementById('cliente').value = 'Cliente de Ejemplo';
            document.getElementById('destino1').value = 'David, Chiriqu√≠';
        });

        // ==================== FUNCIONES DE INICIALIZACI√ìN ====================
        function inicializarMapa() {
            // Inicializar mapa centrado en Panam√°
            map = L.map('map').setView([8.9833, -79.5167], 8);
            
            // Capa base de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            console.log("Mapa inicializado correctamente");
        }

        function configurarAutoRecalcular() {
            const camposAutoRecalcular = [
                'horasExtras', 'tiempoCargaDescarga', 'peajes',
                'chkDesayuno', 'chkAlmuerzo', 'chkCena', 'chkHotel',
                'qtyDesayuno', 'qtyAlmuerzo', 'qtyCena', 'qtyHotel',
                'velocidadPersonal', 'combustible'
            ];
            
            camposAutoRecalcular.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', autoRecalcular);
                    el.addEventListener('change', autoRecalcular);
                }
            });
            
            // Tambi√©n para checkboxes de tipo de carga
            document.querySelectorAll('input[name="carga"]').forEach(el => {
                el.addEventListener('change', autoRecalcular);
            });
        }

        // ==================== FUNCI√ìN PRINCIPAL - TRAZAR RUTA ====================
        async function calcularRuta() {
            try {
                // Validar datos b√°sicos
                const cliente = document.getElementById('cliente').value.trim();
                const origen = document.getElementById('origen').value.trim();
                const destinos = obtenerDestinos();
                
                if (!cliente || !origen || destinos.length === 0) {
                    mostrarAlerta('Por favor complete: Cliente, Origen y al menos un Destino', 'danger');
                    return;
                }
                
                // Mostrar loading
                mostrarLoading();
                
                // Obtener waypoints
                waypoints = [origen, ...destinos];
                
                // Geocodificar waypoints
                const coordenadas = await geocodificarWaypoints(waypoints);
                
                // Limpiar ruta anterior
                limpiarRuta();
                
                // Crear marcadores para cada punto
                crearMarcadores(coordenadas, waypoints);
                
                // Calcular y mostrar ruta
                await trazarRutaEnMapa(coordenadas);
                
                // Calcular distancias y tiempos
                const infoRuta = await calcularInfoRuta(coordenadas);
                
                // Calcular costos
                const costos = calcularCostos(infoRuta.distanciaTotal, infoRuta.tiempoTotal);
                
                // Calcular precios
                const precios = calcularPrecios(costos.total);
                
                // Mostrar resultados
                mostrarResultados(infoRuta, costos, precios);
                
                // Habilitar botones
                habilitarBotones();
                
                // Guardar informaci√≥n de la ruta actual
                currentRouteInfo = {
                    waypoints: waypoints,
                    coordenadas: coordenadas,
                    info: infoRuta,
                    costos: costos
                };
                
                // Crear objeto de cotizaci√≥n
                cotizacionActual = {
                    id: generarId(),
                    fecha: new Date().toLocaleString('es-PA'),
                    numero: document.getElementById('numeroCotizacion').textContent,
                    cliente: cliente,
                    contacto: document.getElementById('contacto').value.trim(),
                    origen: origen,
                    destinos: destinos,
                    vehiculo: document.getElementById('vehiculo').value,
                    peso: parseFloat(document.getElementById('peso').value) || 0,
                    volumen: parseFloat(document.getElementById('volumen').value) || 0,
                    infoRuta: infoRuta,
                    costos: costos,
                    precios: precios,
                    montoTransporte: parseFloat(document.getElementById('inputMontoTransporte').value) || 0,
                    observaciones: document.getElementById('observaciones') ? document.getElementById('observaciones').value : ''
                };
                
                // Generar mensaje WhatsApp
                document.getElementById('customWhatsAppText').value = generarTextoWhatsApp();
                document.getElementById('customMsgBox').style.display = 'block';
                
                // Mostrar mensaje de √©xito
                mostrarAlerta(`¬°Ruta trazada! Distancia: ${infoRuta.distanciaTotal} km | Tiempo: ${infoRuta.tiempoTotal} min`, 'success');
                
            } catch (error) {
                mostrarAlerta('Error al trazar ruta: ' + error.message, 'danger');
                console.error('Error en calcularRuta:', error);
            }
        }

        // ==================== FUNCIONES DE GEOCODIFICACI√ìN ====================
        async function geocodificarWaypoints(waypoints) {
            const coordenadas = [];
            
            for (const waypoint of waypoints) {
                try {
                    const coords = await geocodificar(waypoint + ', Panam√°');
                    coordenadas.push(coords);
                } catch (error) {
                    // Si falla la geocodificaci√≥n, usar coordenadas aproximadas
                    const coordsAprox = obtenerCoordenadasAproximadas(waypoint);
                    coordenadas.push(coordsAprox);
                    console.warn(`Usando coordenadas aproximadas para: ${waypoint}`);
                }
            }
            
            return coordenadas;
        }

        async function geocodificar(direccion) {
            // Usar Nominatim de OpenStreetMap
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}&limit=1&countrycodes=pa`;
            
            const response = await fetch(url, {
                headers: {
                    'User-Agent': 'CotizadorIFS/1.0'
                }
            });
            
            if (!response.ok) throw new Error('Error en geocodificaci√≥n');
            
            const data = await response.json();
            
            if (data.length === 0) {
                throw new Error('Direcci√≥n no encontrada: ' + direccion);
            }
            
            return {
                lat: parseFloat(data[0].lat),
                lng: parseFloat(data[0].lon),
                nombre: data[0].display_name
            };
        }

        function obtenerCoordenadasAproximadas(ubicacion) {
            // Coordenadas aproximadas de ubicaciones comunes en Panam√°
            const ubicaciones = {
                'ciudad de panam√°': { lat: 8.9833, lng: -79.5167 },
                'panam√°': { lat: 8.9833, lng: -79.5167 },
                'david': { lat: 8.4333, lng: -82.4333 },
                'chiriqu√≠': { lat: 8.4333, lng: -82.4333 },
                'santiago': { lat: 8.1000, lng: -80.9833 },
                'veraguas': { lat: 8.1000, lng: -80.9833 },
                'chitr√©': { lat: 7.9667, lng: -80.4333 },
                'herrera': { lat: 7.9667, lng: -80.4333 },
                'las tablas': { lat: 7.7667, lng: -80.2833 },
                'los santos': { lat: 7.9333, lng: -80.4167 },
                'col√≥n': { lat: 9.3589, lng: -79.9000 },
                'bocas del toro': { lat: 9.3400, lng: -82.2500 },
                'penonom√©': { lat: 8.5167, lng: -80.3500 },
                'cocl√©': { lat: 8.5167, lng: -80.3500 },
                'la chorrera': { lat: 8.8792, lng: -79.7822 },
                'arraij√°n': { lat: 8.9500, lng: -79.6500 },
                'tocumen': { lat: 9.0833, lng: -79.3833 }
            };
            
            const ubicacionLower = ubicacion.toLowerCase();
            
            for (const [key, coords] of Object.entries(ubicaciones)) {
                if (ubicacionLower.includes(key)) {
                    return {
                        lat: coords.lat,
                        lng: coords.lng,
                        nombre: ubicacion
                    };
                }
            }
            
            // Coordenadas por defecto
            return {
                lat: 8.9833 + (Math.random() - 0.5) * 0.5,
                lng: -79.5167 + (Math.random() - 0.5) * 0.5,
                nombre: ubicacion
            };
        }

        // ==================== FUNCIONES DEL MAPA ====================
        function crearMarcadores(coordenadas, nombres) {
            // Limpiar marcadores anteriores
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Colores para diferentes puntos
            const colores = ['#28a745', '#dc3545', '#007bff', '#ffc107', '#6f42c1', '#20c997', '#fd7e14', '#e83e8c'];
            
            coordenadas.forEach((coords, index) => {
                let icono;
                let titulo = nombres[index];
                
                if (index === 0) {
                    // Origen - icono verde
                    icono = L.divIcon({
                        html: `<div style="background:${colores[0]};color:white;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:bold;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);">
                                 <span style="font-size:18px;">${index + 1}</span>
                               </div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40],
                        popupAnchor: [0, -40],
                        className: 'marker-origen'
                    });
                    titulo = `üèÅ ORIGEN: ${titulo}`;
                } else {
                    // Destinos - iconos con diferentes colores
                    icono = L.divIcon({
                        html: `<div style="background:${colores[index % colores.length]};color:white;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-weight:bold;border:3px solid white;box-shadow:0 0 10px rgba(0,0,0,0.3);">
                                 <span style="font-size:16px;">${index + 1}</span>
                               </div>`,
                        iconSize: [36, 36],
                        iconAnchor: [18, 36],
                        popupAnchor: [0, -36],
                        className: 'marker-destino'
                    });
                    titulo = `üìç DESTINO ${index}: ${titulo}`;
                }
                
                const marker = L.marker([coords.lat, coords.lng], { icon: icono })
                    .addTo(map)
                    .bindPopup(`<strong>${titulo}</strong><br>${coords.nombre || 'Coordenadas: ' + coords.lat.toFixed(4) + ', ' + coords.lng.toFixed(4)}`)
                    .openPopup();
                
                markers.push(marker);
            });
            
            // Ajustar vista para mostrar todos los marcadores
            if (coordenadas.length > 0) {
                const bounds = L.latLngBounds(coordenadas.map(c => [c.lat, c.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        async function trazarRutaEnMapa(coordenadas) {
            // Limpiar ruta anterior
            if (routingControl) {
                map.removeControl(routingControl);
            }
            
            // Convertir coordenadas al formato de Leaflet Routing Machine
            const waypointsLRM = coordenadas.map(coord => 
                L.latLng(coord.lat, coord.lng)
            );
            
            // Crear ruta con Leaflet Routing Machine
            routingControl = L.Routing.control({
                waypoints: waypointsLRM,
                routeWhileDragging: false,
                showAlternatives: false,
                lineOptions: {
                    styles: [
                        {color: '#007bff', opacity: 0.8, weight: 6},
                        {color: '#0056b3', opacity: 0.3, weight: 10}
                    ],
                    extendToWaypoints: true,
                    missingRouteTolerance: 10
                },
                altLineOptions: {
                    styles: [
                        {color: '#666', opacity: 0.7, weight: 4}
                    ]
                },
                show: true,
                collapsible: true,
                fitSelectedRoutes: false,
                addWaypoints: false
            }).addTo(map);
            
            // Esperar a que se calcule la ruta
            return new Promise((resolve, reject) => {
                routingControl.on('routesfound', function(e) {
                    const routes = e.routes;
                    if (routes && routes.length > 0) {
                        resolve(routes[0]);
                    } else {
                        reject(new Error('No se encontr√≥ ruta'));
                    }
                });
                
                // Timeout si tarda demasiado
                setTimeout(() => {
                    // Si no hay respuesta del servicio de routing, calcular ruta manual
                    calcularRutaManual(coordenadas);
                    resolve(null);
                }, 5000);
            });
        }

        // ==================== C√ÅLCULOS DE RUTA ====================
        async function calcularInfoRuta(coordenadas) {
            let distanciaTotal = 0;
            let tiempoTotal = 0;
            
            // Calcular distancia entre cada par de puntos
            for (let i = 0; i < coordenadas.length - 1; i++) {
                const distancia = calcularDistanciaDirecta(
                    [coordenadas[i].lat, coordenadas[i].lng],
                    [coordenadas[i + 1].lat, coordenadas[i + 1].lng]
                );
                
                distanciaTotal += distancia;
                
                // Obtener velocidad del veh√≠culo
                const vehiculo = document.getElementById('vehiculo').value;
                const config = VEHICULOS[vehiculo] || VEHICULOS.CF14;
                const velocidad = document.getElementById('checkVeloPers').checked ? 
                    parseFloat(document.getElementById('velocidadPersonal').value) : 
                    config.velocidad;
                
                // Calcular tiempo basado en velocidad
                const tiempoHoras = distancia / velocidad;
                tiempoTotal += tiempoHoras;
            }
            
            // Convertir tiempo a minutos
            tiempoTotal = Math.round(tiempoTotal * 60);
            
            // Aplicar factor de tiempo seg√∫n veh√≠culo
            const factorVeh = factoresTiempo[document.getElementById('vehiculo').value] || 1;
            tiempoTotal = Math.round(tiempoTotal * factorVeh);
            
            return {
                distanciaTotal: Math.round(distanciaTotal),
                tiempoTotal: tiempoTotal,
                numDestinos: coordenadas.length - 1
            };
        }

        function calcularDistanciaDirecta(punto1, punto2) {
            // F√≥rmula Haversine para calcular distancia entre dos puntos
            const R = 6371; // Radio de la Tierra en km
            const dLat = (punto2[0] - punto1[0]) * Math.PI / 180;
            const dLon = (punto2[1] - punto1[1]) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(punto1[0] * Math.PI / 180) * Math.cos(punto2[0] * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ==================== C√ÅLCULO DE COSTOS ====================
        function calcularCostos(distancia, tiempoMinutos) {
            const vehiculo = document.getElementById('vehiculo').value;
            const config = VEHICULOS[vehiculo] || VEHICULOS.CF14;
            
            // 1. Costo de combustible
            const precioCombustible = parseFloat(document.getElementById('combustible').value) || 0.85;
            const litros = distancia / config.consumo;
            const costoCombustible = litros * precioCombustible;
            
            // 2. Costo del conductor (tiempo de viaje)
            const horasViaje = tiempoMinutos / 60;
            const costoConductorViaje = horasViaje * config.costoHora;
            
            // 3. Horas extras
            const horasExtras = parseFloat(document.getElementById('horasExtras').value) || 0;
            const costoHorasExtras = horasExtras * config.costoHora;
            
            // 4. Tiempo carga/descarga
            const tiempoCargaDescarga = parseFloat(document.getElementById('tiempoCargaDescarga').value) || 1.12;
            const costoCargaDescarga = tiempoCargaDescarga * config.costoHora;
            
            // 5. Tiempo de despacho en cada destino
            let totalTiempoDespacho = 0;
            const tiempoDespachoInputs = document.querySelectorAll('.tiempo-despacho-input');
            if (tiempoDespachoInputs.length > 0) {
                tiempoDespachoInputs.forEach(input => {
                    totalTiempoDespacho += parseFloat(input.value) || 15;
                });
            } else {
                totalTiempoDespacho = (waypoints.length - 1) * 15; // 15 min por destino por defecto
            }
            const costoDespacho = (totalTiempoDespacho / 60) * config.costoHora;
            
            // 6. Vi√°ticos y hospedaje
            const viaticos = parseFloat(document.getElementById('viaticos').value) || 0;
            const hospedaje = parseFloat(document.getElementById('hospedaje').value) || 0;
            
            // 7. Peajes
            const peajes = parseFloat(document.getElementById('peajes').value) || 0;
            
            // 8. Factor por tipo de carga
            let factorCarga = 1.0;
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                const tipoCarga = cb.value;
                if (factoresCarga[tipoCarga]) {
                    factorCarga *= factoresCarga[tipoCarga];
                }
            });
            
            // Calcular subtotales
            const subtotalCombustible = costoCombustible;
            const subtotalPersonal = costoConductorViaje + costoHorasExtras + costoCargaDescarga + costoDespacho;
            const subtotalViaticos = viaticos + hospedaje;
            const subtotalPeajes = peajes;
            
            // Calcular total
            const subtotal = subtotalCombustible + subtotalPersonal + subtotalViaticos + subtotalPeajes;
            const total = subtotal * factorCarga;
            
            return {
                combustible: costoCombustible,
                conductorViaje: costoConductorViaje,
                horasExtras: costoHorasExtras,
                cargaDescarga: costoCargaDescarga,
                despacho: costoDespacho,
                personal: subtotalPersonal,
                viaticos: viaticos,
                hospedaje: hospedaje,
                viaticosHotel: subtotalViaticos,
                peajes: peajes,
                factorCarga: factorCarga,
                subtotal: subtotal,
                total: total,
                tiempoDespachoTotal: totalTiempoDespacho
            };
        }

        function calcularPrecios(costoBase) {
            return {
                base: costoBase,
                precio25: costoBase * 1.25,
                precio35: costoBase * 1.35,
                precio40: costoBase * 1.40,
                sugerido: costoBase * 1.30
            };
        }

        // ==================== VI√ÅTICOS ====================
        function calcViaticos() {
            let total = 0;
            ['Desayuno', 'Almuerzo', 'Cena', 'Hotel'].forEach(item => {
                const chk = document.getElementById('chk' + item);
                const qty = document.getElementById('qty' + item);
                const sub = document.getElementById('sub' + item);
                const t = chk.checked ? qty.value * prices[item.toLowerCase()] : 0;
                sub.textContent = t.toFixed(2);
                total += t;
            });
            document.getElementById('totalViaticos').textContent = total.toFixed(2);
            const hotelTotal = document.getElementById('chkHotel').checked ? prices.hotel * document.getElementById('qtyHotel').value : 0;
            document.getElementById('hospedaje').value = hotelTotal.toFixed(2);
            document.getElementById('viaticos').value = (total - hotelTotal).toFixed(2);
            
            // Recalcular costos si hay una ruta activa
            if (currentRouteInfo) {
                autoRecalcular();
            }
        }

        // ==================== CONTROL DE VELOCIDAD ====================
        function toggleVelocidadPersonalizada() {
            const chk = document.getElementById('checkVeloPers');
            const btn = document.getElementById('btnToggleVelocidad');
            const wrapper = document.getElementById('veloPersWrapper');
            
            chk.checked = !chk.checked;
            wrapper.style.display = chk.checked ? 'block' : 'none';
            btn.textContent = chk.checked ? 'üö¶ Velocidad manual: ON' : 'üö¶ Velocidad manual: OFF';
            btn.className = chk.checked ? 'toggle-btn active' : 'toggle-btn';
            
            if (currentRouteInfo) {
                autoRecalcular();
            }
        }

        // ==================== CONTROL DE PEAJES ====================
        function toggleEvitarPeaje() {
            const chk = document.getElementById('evitarPeajes');
            const btn = document.getElementById('btnTogglePeaje');
            chk.checked = !chk.checked;
            btn.textContent = chk.checked ? 'üõ£Ô∏è Sin peajes: ON' : 'üõ£Ô∏è Sin peajes: OFF';
            btn.className = chk.checked ? 'toggle-btn active' : 'toggle-btn';
            
            if (currentRouteInfo) {
                // Nota: Para implementar evitar peajes en el routing, necesitar√≠as OpenRouteService
                mostrarAlerta('Para evitar peajes en la ruta, se requiere conexi√≥n con OpenRouteService', 'info');
            }
        }

        // ==================== MONTO DEL TRANSPORTE ====================
        function actualizarMontoTransporte() {
            const valor = parseFloat(document.getElementById('inputMontoTransporte').value) || 0;
            document.getElementById('montoTransporte').textContent = 'US$ ' + valor.toFixed(2);
        }

        function mostrarMontoTransporte() {
            // Funci√≥n para mostrar la secci√≥n de monto del transporte
            const seccion = document.querySelector('.monto-transporte');
            if (seccion) {
                seccion.style.display = 'block';
            }
        }

        // ==================== VISUALIZACI√ìN DE RESULTADOS ====================
        function mostrarResultados(infoRuta, costos, precios) {
            // Mostrar informaci√≥n de la ruta
            document.getElementById('rutaInfo').style.display = 'block';
            document.getElementById('distanciaTotal').textContent = `${infoRuta.distanciaTotal} km`;
            document.getElementById('tiempoTotal').textContent = `${infoRuta.tiempoTotal} min`;
            document.getElementById('costoCombustible').textContent = `$${costos.combustible.toFixed(2)}`;
            document.getElementById('costoViaticosHotel').textContent = `$${costos.viaticosHotel.toFixed(2)}`;
            document.getElementById('costoPersonal').textContent = `$${costos.personal.toFixed(2)}`;
            document.getElementById('costoDespacho').textContent = `$${costos.despacho.toFixed(2)}`;
            document.getElementById('costoPeajes').textContent = `$${costos.peajes.toFixed(2)}`;
            document.getElementById('costoBase').textContent = `$${costos.total.toFixed(2)}`;
            
            // Mostrar precio sugerido
            document.getElementById('priceDisplay').style.display = 'block';
            document.getElementById('precioSugerido').textContent = `$${precios.sugerido.toFixed(2)}`;
            
            // Mostrar detalles completos
            const vehiculo = document.getElementById('vehiculo').value;
            const config = VEHICULOS[vehiculo] || VEHICULOS.CF14;
            const tiposCarga = Array.from(document.querySelectorAll('input[name="carga"]:checked'))
                .map(cb => cb.value)
                .join(', ') || 'Ninguno';
            
            document.getElementById('resultadosDetalles').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #003366; margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> DETALLES DE LA COTIZACI√ìN
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p><strong><i class="fas fa-user"></i> Cliente:</strong> ${document.getElementById('cliente').value}</p>
                            <p><strong><i class="fas fa-truck"></i> Veh√≠culo:</strong> ${config.nombre}</p>
                            <p><strong><i class="fas fa-map-pin"></i> Destinos:</strong> ${waypoints.length - 1}</p>
                            <p><strong><i class="fas fa-clock"></i> Tiempo despacho total:</strong> ${costos.tiempoDespachoTotal || 0} min</p>
                        </div>
                        <div>
                            <p><strong><i class="fas fa-route"></i> Ruta:</strong> ${waypoints[0]} ‚Üí ${waypoints.slice(1).join(' ‚Üí ')}</p>
                            <p><strong><i class="fas fa-box"></i> Tipo de carga:</strong> ${tiposCarga}</p>
                            <p><strong><i class="fas fa-weight-hanging"></i> Carga:</strong> ${document.getElementById('peso').value} kg / ${document.getElementById('volumen').value} m¬≥</p>
                            <p><strong><i class="fas fa-tag"></i> Markup:</strong> 30%</p>
                        </div>
                    </div>
                </div>
                
                <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; margin-bottom: 15px;">
                    <h5 style="color: #0056b3; margin-bottom: 10px;">
                        <i class="fas fa-tags"></i> COSTOS DETALLADOS
                    </h5>
                    <div style="font-size: 14px; line-height: 1.6;">
                        <p><strong>Combustible:</strong> $${costos.combustible.toFixed(2)}</p>
                        <p><strong>Personal conductor:</strong> $${costos.conductorViaje.toFixed(2)}</p>
                        <p><strong>Horas extras:</strong> $${costos.horasExtras.toFixed(2)}</p>
                        <p><strong>Carga/descarga:</strong> $${costos.cargaDescarga.toFixed(2)}</p>
                        <p><strong>Tiempo despacho:</strong> $${costos.despacho.toFixed(2)} (${costos.tiempoDespachoTotal} min)</p>
                        <p><strong>Vi√°ticos:</strong> $${costos.viaticos.toFixed(2)}</p>
                        <p><strong>Hospedaje:</strong> $${costos.hospedaje.toFixed(2)}</p>
                        <p><strong>Peajes:</strong> $${costos.peajes.toFixed(2)}</p>
                        <p style="border-top: 1px solid #ccc; padding-top: 8px; margin-top: 8px; font-weight: bold;">
                            <strong>TOTAL COSTO BASE:</strong> $${costos.total.toFixed(2)}
                        </p>
                    </div>
                </div>
                
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #28a745;">
                    <h5 style="color: #28a745; margin-bottom: 10px;">
                        <i class="fas fa-tags"></i> PRECIOS FINALES
                    </h5>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;">
                        <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                            <div style="font-size: 12px; color: #666;">Costo Base</div>
                            <div style="font-size: 18px; font-weight: bold;">$${costos.total.toFixed(2)}</div>
                        </div>
                        <div style="background: #d4edda; padding: 10px; border-radius: 6px; border: 1px solid #28a745;">
                            <div style="font-size: 12px; color: #155724;">+25%</div>
                            <div style="font-size: 18px; font-weight: bold; color: #28a745;">$${precios.precio25.toFixed(2)}</div>
                        </div>
                        <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border: 1px solid #ffc107;">
                            <div style="font-size: 12px; color: #856404;">+35%</div>
                            <div style="font-size: 18px; font-weight: bold; color: #ffc107;">$${precios.precio35.toFixed(2)}</div>
                        </div>
                        <div style="background: #f8d7da; padding: 10px; border-radius: 6px; border: 1px solid #dc3545;">
                            <div style="font-size: 12px; color: #721c24;">+40%</div>
                            <div style="font-size: 18px; font-weight: bold; color: #dc3545;">$${precios.precio40.toFixed(2)}</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 14px; color: #666;">
                        <i class="fas fa-info-circle"></i> Precio sugerido con 30% markup: <strong>$${precios.sugerido.toFixed(2)}</strong>
                    </div>
                </div>
            `;
        }

        // ==================== DESTINOS DIN√ÅMICOS ====================
        function agregarDestino() {
            const container = document.getElementById('destinosContainer');
            const numDestinos = container.querySelectorAll('.destino-item').length;
            
            if (numDestinos >= 10) {
                mostrarAlerta('M√°ximo 10 destinos permitidos', 'warning');
                return;
            }
            
            const nuevoNum = numDestinos + 1;
            const colores = ['#dc3545', '#007bff', '#ffc107', '#6f42c1', '#20c997', '#fd7e14', '#e83e8c', '#17a2b8', '#6c757d', '#343a40'];
            const color = colores[(nuevoNum - 1) % colores.length];
            
            const div = document.createElement('div');
            div.className = 'destino-item';
            div.id = `destino${nuevoNum}-container`;
            div.innerHTML = `
                <div class="destino-item-header">
                    <div class="destino-number" style="background: ${color};">${nuevoNum}</div>
                    <div class="destino-controls">
                        <button onclick="eliminarDestino(${nuevoNum})" class="btn-danger" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label style="color: ${color};"><i class="fas fa-map-marker-alt"></i> Destino ${nuevoNum}</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="destino${nuevoNum}" class="form-control destino-input" placeholder="Ej: Santiago, Veraguas">
                        <input type="number" class="tiempo-despacho-input" id="tiempoDespacho${nuevoNum}" min="5" step="5" value="15" placeholder="Min" 
                               title="Tiempo de despacho (minutos)" oninput="autoRecalcular()">
                    </div>
                </div>
            `;
            
            container.appendChild(div);
            
            // Configurar eventos para el nuevo input
            const input = document.getElementById(`destino${nuevoNum}`);
            if (input) {
                input.addEventListener('change', function() {
                    if (this.value.trim() !== '') {
                        autoRecalcular();
                    }
                });
            }
        }

        function eliminarDestino(numero) {
            // No permitir eliminar el primer destino
            if (numero === 1) {
                mostrarAlerta('El primer destino no puede ser eliminado', 'warning');
                return;
            }
            
            const container = document.getElementById(`destino${numero}-container`);
            if (container) {
                container.remove();
                renumerarDestinos();
                autoRecalcular();
            }
        }

        function renumerarDestinos() {
            const containers = document.querySelectorAll('#destinosContainer .destino-item');
            const colores = ['#dc3545', '#007bff', '#ffc107', '#6f42c1', '#20c997', '#fd7e14', '#e83e8c', '#17a2b8', '#6c757d', '#343a40'];
            
            containers.forEach((container, index) => {
                const nuevoNum = index + 1;
                const color = colores[index % colores.length];
                
                // Actualizar n√∫mero
                const numberDiv = container.querySelector('.destino-number');
                if (numberDiv) {
                    numberDiv.textContent = nuevoNum;
                    numberDiv.style.background = color;
                }
                
                // Actualizar label
                const label = container.querySelector('label');
                if (label) {
                    label.innerHTML = `<i class="fas fa-map-marker-alt"></i> Destino ${nuevoNum}`;
                    label.style.color = color;
                }
                
                // Actualizar IDs de los inputs
                const input = container.querySelector('input[type="text"]');
                const tiempoInput = container.querySelector('.tiempo-despacho-input');
                
                if (input) {
                    input.id = `destino${nuevoNum}`;
                }
                if (tiempoInput) {
                    tiempoInput.id = `tiempoDespacho${nuevoNum}`;
                    tiempoInput.oninput = function() { autoRecalcular(); };
                }
                
                // Actualizar funci√≥n de eliminaci√≥n
                const deleteBtn = container.querySelector('button');
                if (deleteBtn) {
                    deleteBtn.onclick = function() { eliminarDestino(nuevoNum); };
                }
                
                // Hacer requerido solo el primer destino
                if (input) {
                    input.required = (nuevoNum === 1);
                }
            });
        }

        function obtenerDestinos() {
            const destinos = [];
            const inputs = document.querySelectorAll('#destinosContainer .destino-item input[type="text"]');
            
            inputs.forEach(input => {
                if (input.value.trim() !== '') {
                    destinos.push(input.value.trim());
                }
            });
            
            return destinos;
        }

        // ==================== FUNCIONES DE CONTROL DEL MAPA ====================
        function centrarMapa() {
            if (markers.length > 0) {
                const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
                map.fitBounds(bounds, { padding: [50, 50] });
            } else {
                map.setView([8.9833, -79.5167], 8);
            }
        }

        function centrarEnOrigen() {
            if (!map || !currentRouteInfo || !currentRouteInfo.coordenadas) return;
            const origen = currentRouteInfo.coordenadas[0];
            map.setView([origen.lat, origen.lng], 12);
        }

        function mostrarDistancias() {
            if (!currentRouteInfo || !currentRouteInfo.coordenadas || currentRouteInfo.coordenadas.length < 2) {
                mostrarAlerta('No hay coordenadas de recorrido disponibles.', 'warning');
                return;
            }

            const distancias = [];
            for (let i = 0; i < currentRouteInfo.coordenadas.length - 1; i++) {
                const from = currentRouteInfo.coordenadas[i];
                const to = currentRouteInfo.coordenadas[i + 1];

                const dist = calcularDistanciaDirecta([from.lat, from.lng], [to.lat, to.lng]);
                const puntoA = i === 0 ? 'Origen' : `Destino ${i}`;
                const puntoB = i + 1 === currentRouteInfo.coordenadas.length - 1 ? `Destino ${i + 1}` : `Destino ${i + 1}`;
                distancias.push(`${puntoA} ‚Üí ${puntoB}: ${dist.toFixed(2)} km`);
            }

            mostrarAlerta("Distancias entre puntos:<br><br>" + distancias.join('<br>'), 'info');
        }

        function limpiarRuta() {
            // Limpiar marcadores
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Limpiar control de ruta
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            
            // Limpiar informaci√≥n de ruta
            currentRouteInfo = null;
            cotizacionActual = null;
            
            // Ocultar resultados
            document.getElementById('rutaInfo').style.display = 'none';
            document.getElementById('priceDisplay').style.display = 'none';
            document.getElementById('customMsgBox').style.display = 'none';
            document.getElementById('resultadosDetalles').innerHTML = `
                <div style="text-align: center; padding: 30px; color: #6c757d;">
                    <i class="fas fa-route" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                    <h4>Complete la ruta y haga clic en "TRAZAR RUTA"</h4>
                    <p>El mapa mostrar√° la ruta completa con distancias y tiempos</p>
                </div>
            `;
            
            // Deshabilitar botones
            document.getElementById('btnGuardar').disabled = true;
            document.getElementById('btnWhatsApp').disabled = true;
            document.getElementById('btnImprimir').disabled = true;
            document.getElementById('btnDescargar').disabled = true;
        }

        function alternarSatelite() {
            // Esta funci√≥n alternar√≠a entre mapa normal y sat√©lite
            mostrarAlerta('Funcionalidad de vista sat√©lite en desarrollo', 'info');
        }

        // ==================== NUMERO DE COTIZACI√ìN ====================
        function actualizarNumeroCotizacion() {
            const fecha = new Date();
            const yyyy = fecha.getFullYear();
            const mm = String(fecha.getMonth() + 1).padStart(2, '0');
            const dd = String(fecha.getDate()).padStart(2, '0');
            
            // Obtener c√≥digo de √°rea
            const codigoAreaSelect = document.getElementById('codigoArea');
            let codigoArea = 'TRA'; // Valor por defecto
            
            if (codigoAreaSelect) {
                codigoArea = codigoAreaSelect.value || 'TRA';
            }
            
            // Generar n√∫mero secuencial
            let correlativo = localStorage.getItem('correlativoCotizacionIFS') || 1000;
            correlativo = parseInt(correlativo);
            if (isNaN(correlativo)) correlativo = 1000;
            
            const numero = `COT-${yyyy}${mm}${dd}-${codigoArea}-${correlativo}`;
            document.getElementById('numeroCotizacion').textContent = numero;
            
            return numero;
        }

        // ==================== FUNCIONES DE VEH√çCULO ====================
        function actualizarVelocidadVehiculo() {
            const veh = document.getElementById('vehiculo').value;
            const config = VEHICULOS[veh] || VEHICULOS.CF14;
            document.getElementById('velocidadTexto').textContent = `${config.velocidad} km/h`;
            document.getElementById('pesoVehiculoTexto').textContent = `${config.pesoMax.toLocaleString('es-ES')} kg`;
            document.getElementById('volumenVehiculoTexto').textContent = `${config.volumenMax.toLocaleString('es-ES')} m¬≥`;
        }

        function calcularPorcentajeCarga() {
            const veh = document.getElementById('vehiculo').value;
            const config = VEHICULOS[veh] || VEHICULOS.CF14;
            const pesoCarga = parseFloat(document.getElementById('peso').value) || 0;
            const volCarga  = parseFloat(document.getElementById('volumen').value) || 0;

            const pctPeso = config.pesoMax > 0 ? (pesoCarga / config.pesoMax * 100) : 0;
            const pctVol  = config.volumenMax > 0 ? (volCarga  / config.volumenMax  * 100) : 0;

            const txtPeso = pesoCarga === 0 ? '‚Äì' : `${pctPeso.toFixed(1)} %`;
            const txtVol  = volCarga  === 0 ? '‚Äì' : `${pctVol.toFixed(1)} %`;

            const casilla = document.getElementById('porcentajeCargaTexto');
            casilla.textContent = `${txtPeso} / ${txtVol}`;

            const maxPct = Math.max(pctPeso, pctVol);
            casilla.classList.remove('bajo','medio','alto');
            if (maxPct >= 70)        casilla.classList.add('alto');
            else if (maxPct >= 60)   casilla.classList.add('medio');
            else if (maxPct <= 59)   casilla.classList.add('bajo');

            if (maxPct >= 70 && !alerta70Mostrada) {
                alerta70Mostrada = true;
                setTimeout(() => {
                    mostrarAlerta('‚ö†Ô∏è Carga elevada: el peso o volumen supera el 70 % de la capacidad del veh√≠culo.<br>Revisa o considera cambiar de veh√≠culo.', 'warning');
                }, 300);
            } else if (maxPct < 70) {
                alerta70Mostrada = false;
            }
        }

        // ==================== AUTO-RECALCULAR ====================
        function autoRecalcular() {
            clearTimeout(autoRecalcularTimeout);
            autoRecalcularTimeout = setTimeout(() => {
                if (currentRouteInfo && cotizacionActual) {
                    // Recalcular costos con nueva informaci√≥n
                    const costos = calcularCostos(currentRouteInfo.info.distanciaTotal, currentRouteInfo.info.tiempoTotal);
                    const precios = calcularPrecios(costos.total);
                    
                    // Actualizar visualizaci√≥n
                    mostrarResultados(currentRouteInfo.info, costos, precios);
                    
                    // Actualizar cotizaci√≥n actual
                    cotizacionActual.costos = costos;
                    cotizacionActual.precios = precios;
                }
            }, 800); // Debounce de 800ms
        }

        // ==================== WHATSAPP ====================
        function generarTextoWhatsApp() {
            const cliente = document.getElementById('cliente').value || 'Sin cliente';
            const numero = document.getElementById('numeroCotizacion').textContent;
            const origen = document.getElementById('origen').value || 'Sin origen';
            const destinos = obtenerDestinos();
            const vehiculo = document.getElementById('vehiculo').value;
            const config = VEHICULOS[vehiculo] || VEHICULOS.CF14;
            const montoTransporte = parseFloat(document.getElementById('inputMontoTransporte').value) || 0;
            
            let distancia = '0';
            let tiempo = '0';
            if (currentRouteInfo) {
                distancia = currentRouteInfo.info.distanciaTotal;
                tiempo = currentRouteInfo.info.tiempoTotal;
            }
            
            return `üöõ *Cotizaci√≥n de Transporte* - IFS PANAM√Å\n\n` +
                   `Hola *${cliente}*,\n` +
                   `¬°Gracias por elegirnos! Tu cotizaci√≥n *${numero}* ya est√° lista:\n\n` +
                   `üìç Ruta: ${origen} ‚Üí ${destinos.join(' ‚Üí ')}\n` +
                   `üöõ Veh√≠culo: ${config.nombre}\n` +
                   `üìè Distancia: ${distancia} km\n` +
                   `‚è±Ô∏è Tiempo estimado: ${tiempo} min\n` +
                   `üí∞ Precio sugerido: *$${montoTransporte.toFixed(2)}*\n\n` +
                   `üìÖ V√°lida por 30 d√≠as\n\n` +
                   `‚úÖ *Beneficios:*\n‚Ä¢ Seguimiento en tiempo real\n‚Ä¢ Seguro b√°sico de carga\n‚Ä¢ Atenci√≥n personalizada\n\n` +
                   `‚è≥ *Confirma tu servicio ahora y asegura disponibilidad.*\n` +
                   `Responde a este mensaje para confirmar.`;
        }

        function enviarWhatsAppCustom() {
            const texto = document.getElementById('customWhatsAppText').value.trim();
            if (!texto) {
                mostrarAlerta('El mensaje est√° vac√≠o.', 'warning');
                return;
            }
            const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
            window.open(url, '_blank');
        }

        function copiarMensajeCustom() {
            const texto = document.getElementById('customWhatsAppText').value.trim();
            if (!texto) {
                mostrarAlerta('El mensaje est√° vac√≠o.', 'warning');
                return;
            }
            navigator.clipboard.writeText(texto).then(() => {
                mostrarAlerta('Mensaje personalizado copiado ‚úÖ', 'success');
            }).catch(err => {
                mostrarAlerta('Error al copiar: ' + err, 'danger');
            });
        }

        function enviarWhatsApp() {
            if (!cotizacionActual) {
                mostrarAlerta('Primero debe trazar una ruta', 'warning');
                return;
            }
            
            const mensaje = `*COTIZACI√ìN IFS - RUTA CON MAPA*%0A%0A` +
                           `*Cliente:* ${cotizacionActual.cliente}%0A` +
                           `*Ruta:* ${cotizacionActual.origen} ‚Üí ${cotizacionActual.destinos.join(' ‚Üí ')}%0A` +
                           `*Distancia:* ${cotizacionActual.infoRuta.distanciaTotal} km%0A` +
                           `*Tiempo:* ${cotizacionActual.infoRuta.tiempoTotal} min%0A` +
                           `*Veh√≠culo:* ${VEHICULOS[cotizacionActual.vehiculo]?.nombre || cotizacionActual.vehiculo}%0A` +
                           `*Precio Sugerido:* $${cotizacionActual.precios.sugerido.toFixed(2)}%0A%0A` +
                           `*¬øAcepta la cotizaci√≥n?*%0A` +
                           `Responda a este mensaje para confirmar el servicio.`;
            
            window.open(`https://wa.me/?text=${mensaje}`, '_blank');
        }

        // ==================== FUNCIONES DE GUARDADO Y HISTORIAL ====================
        function guardarCotizacion() {
            if (!cotizacionActual) {
                mostrarAlerta('Primero debe trazar una ruta', 'warning');
                return;
            }
            
            try {
                // Obtener historial existente
                const historialGuardado = localStorage.getItem('cotizacionesHistorialIFS');
                historial = historialGuardado ? JSON.parse(historialGuardado) : [];
                
                // Incrementar correlativo
                let correlativo = localStorage.getItem('correlativoCotizacionIFS') || 1000;
                correlativo = parseInt(correlativo) + 1;
                localStorage.setItem('correlativoCotizacionIFS', correlativo);
                
                // Obtener tipos de carga seleccionados
                const tiposCarga = Array.from(document.querySelectorAll('input[name="carga"]:checked'))
                    .map(cb => cb.value)
                    .join(', ') || 'Ninguno';
                
                // Crear registro completo
                const registro = {
                    id: cotizacionActual.id,
                    fecha: new Date().toLocaleString('es-PA'),
                    numero: document.getElementById('numeroCotizacion').textContent,
                    cliente: cotizacionActual.cliente,
                    contacto: cotizacionActual.contacto,
                    origen: cotizacionActual.origen,
                    destinos: cotizacionActual.destinos.join(' ‚Üí '),
                    vehiculo: cotizacionActual.vehiculo,
                    tipoCarga: tiposCarga,
                    distancia: cotizacionActual.infoRuta.distanciaTotal,
                    tiempo: cotizacionActual.infoRuta.tiempoTotal,
                    viaticosHotel: cotizacionActual.costos.viaticosHotel,
                    combustible: parseFloat(cotizacionActual.costos.combustible),
                    personal: parseFloat(cotizacionActual.costos.personal),
                    peaje: parseFloat(cotizacionActual.costos.peajes),
                    costoBase: parseFloat(cotizacionActual.costos.total),
                    precio25: parseFloat(cotizacionActual.precios.precio25),
                    precio35: parseFloat(cotizacionActual.precios.precio35),
                    precio40: parseFloat(cotizacionActual.precios.precio40),
                    montoTransporte: parseFloat(document.getElementById('inputMontoTransporte').value) || 0,
                    peso: cotizacionActual.peso,
                    volumen: cotizacionActual.volumen,
                    porcentajeCarga: document.getElementById('porcentajeCargaTexto').textContent
                };
                
                // Agregar nueva cotizaci√≥n
                historial.unshift(registro);
                
                // Limitar a √∫ltimas 100 cotizaciones
                if (historial.length > 100) {
                    historial = historial.slice(0, 100);
                }
                
                // Guardar en localStorage
                localStorage.setItem('cotizacionesHistorialIFS', JSON.stringify(historial));
                
                // Actualizar tabla
                cargarHistorial();
                
                // Actualizar bot√≥n
                const btn = document.getElementById('btnGuardar');
                btn.innerHTML = '<i class="fas fa-check"></i> GUARDADO';
                btn.disabled = true;
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-save"></i> GUARDAR';
                    btn.disabled = false;
                }, 2000);
                
                // Mostrar mensaje de √©xito
                mostrarAlerta('Cotizaci√≥n guardada en el historial', 'success');
                
            } catch (error) {
                mostrarAlerta('Error al guardar: ' + error.message, 'danger');
            }
        }

        function cargarHistorial(filtro = '') {
            try {
                const historialGuardado = localStorage.getItem('cotizacionesHistorialIFS');
                historial = historialGuardado ? JSON.parse(historialGuardado) : [];
                
                const tbody = document.getElementById('historialBody');
                tbody.innerHTML = '';
                
                if (historial.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="19" style="text-align: center; padding: 40px; color: #6c757d;">
                                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                                <p>No hay cotizaciones guardadas</p>
                                <small>Trazar y guardar una ruta para comenzar</small>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                historial.forEach((cot, index) => {
                    const textoBusqueda = `${cot.cliente} ${cot.vehiculo} ${cot.fecha} ${cot.tipoCarga} ${cot.numero}`.toLowerCase();
                    if (filtro && !textoBusqueda.includes(filtro.toLowerCase())) return;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${cot.fecha}</td>
                        <td>${cot.numero}</td>
                        <td>${cot.cliente}</td>
                        <td>${cot.origen}</td>
                        <td>${cot.destinos}</td>
                        <td>${cot.vehiculo}</td>
                        <td>${cot.tipoCarga}</td>
                        <td>${cot.distancia}</td>
                        <td>${cot.tiempo}</td>
                        <td>$${parseFloat(cot.viaticosHotel || 0).toFixed(2)}</td>
                        <td>$${parseFloat(cot.combustible || 0).toFixed(2)}</td>
                        <td>$${parseFloat(cot.personal || 0).toFixed(2)}</td>
                        <td>$${parseFloat(cot.peaje || 0).toFixed(2)}</td>
                        <td>$${parseFloat(cot.costoBase || 0).toFixed(2)}</td>
                        <td>$${parseFloat(cot.precio25 || 0).toFixed(2)}</td>
                        <td>$${parseFloat(cot.precio35 || 0).toFixed(2)}</td>
                        <td>$${parseFloat(cot.precio40 || 0).toFixed(2)}</td>
                        <td>$${parseFloat(cot.montoTransporte || 0).toFixed(2)}</td>
                        <td>
                            <button onclick="cargarCotizacionHistorial(${index})" class="btn" style="padding: 5px 10px; font-size: 12px; background: #007bff; color: white; margin: 2px;">
                                <i class="fas fa-map-marked-alt"></i>
                            </button>
                            <button onclick="eliminarCotizacionHistorial(${index})" class="btn" style="padding: 5px 10px; font-size: 12px; background: #dc3545; color: white; margin: 2px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Error cargando historial:', error);
            }
        }

        function filtrarHistorial() {
            const filtro = document.getElementById('filtroHistorial').value;
            cargarHistorial(filtro);
        }

        function cargarCotizacionHistorial(index) {
            try {
                const cotizacion = historial[index];
                if (!cotizacion) return;
                
                // Cargar datos b√°sicos
                document.getElementById('cliente').value = cotizacion.cliente || '';
                document.getElementById('contacto').value = cotizacion.contacto || '';
                document.getElementById('origen').value = cotizacion.origen || '';
                
                // Cargar destinos (solo uno por ahora para simplificar)
                document.getElementById('destino1').value = cotizacion.destinos.split(' ‚Üí ')[1] || '';
                
                // Cargar veh√≠culo
                document.getElementById('vehiculo').value = cotizacion.vehiculo || 'CF14';
                actualizarVelocidadVehiculo();
                
                // Cargar monto transporte
                document.getElementById('inputMontoTransporte').value = cotizacion.montoTransporte || 0;
                actualizarMontoTransporte();
                
                // Mostrar alerta
                mostrarAlerta('Cotizaci√≥n cargada del historial. Haga clic en "TRAZAR RUTA" para ver el mapa.', 'success');
                
            } catch (error) {
                mostrarAlerta('Error al cargar cotizaci√≥n del historial', 'danger');
            }
        }

        function eliminarCotizacionHistorial(index) {
            if (!confirm('¬øEst√° seguro de eliminar esta cotizaci√≥n del historial?')) return;
            
            try {
                historial.splice(index, 1);
                localStorage.setItem('cotizacionesHistorialIFS', JSON.stringify(historial));
                cargarHistorial();
                mostrarAlerta('Cotizaci√≥n eliminada del historial', 'success');
            } catch (error) {
                mostrarAlerta('Error al eliminar', 'danger');
            }
        }

        function limpiarHistorialConfirm() {
            if (!confirm('¬øEst√° seguro de limpiar TODO el historial?\n\nEsta acci√≥n eliminar√° todas las cotizaciones guardadas y no se puede deshacer.')) return;
            
            localStorage.removeItem('cotizacionesHistorialIFS');
            cargarHistorial();
            mostrarAlerta('Historial limpiado correctamente', 'success');
        }

        function mostrarTodasRutas() {
            mostrarAlerta('Funcionalidad en desarrollo: Mostrar todas las rutas en el mapa', 'info');
        }

        // ==================== EXPORTACI√ìN ====================
        function exportarExcel() {
            try {
                if (historial.length === 0) {
                    mostrarAlerta('No hay datos para exportar', 'warning');
                    return;
                }
                
                // Crear contenido
                const ws_data = [
                    ['Fecha', 'N√∫mero', 'Cliente', 'Contacto', 'Origen', 'Destinos', 'Veh√≠culo', 'Tipo Carga', 'Distancia (km)', 'Tiempo (min)', 'Vi√°ticos+Hotel ($)', 'Combustible ($)', 'Personal ($)', 'Peaje ($)', 'Costo Base ($)', 'Precio +25% ($)', 'Precio +35% ($)', 'Precio +40% ($)', 'Monto Transporte ($)', 'Peso (kg)', 'Volumen (m¬≥)', '% Peso/Vol']
                ];
                
                historial.forEach(cot => {
                    ws_data.push([
                        cot.fecha,
                        cot.numero,
                        cot.cliente,
                        cot.contacto || '',
                        cot.origen,
                        cot.destinos,
                        cot.vehiculo,
                        cot.tipoCarga || 'Ninguno',
                        cot.distancia,
                        cot.tiempo,
                        parseFloat(cot.viaticosHotel || 0).toFixed(2),
                        parseFloat(cot.combustible || 0).toFixed(2),
                        parseFloat(cot.personal || 0).toFixed(2),
                        parseFloat(cot.peaje || 0).toFixed(2),
                        parseFloat(cot.costoBase || 0).toFixed(2),
                        parseFloat(cot.precio25 || 0).toFixed(2),
                        parseFloat(cot.precio35 || 0).toFixed(2),
                        parseFloat(cot.precio40 || 0).toFixed(2),
                        parseFloat(cot.montoTransporte || 0).toFixed(2),
                        cot.peso || 0,
                        cot.volumen || 0,
                        cot.porcentajeCarga || '‚Äì / ‚Äì'
                    ]);
                });
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                
                // Ajustar anchos de columna
                const wscols = [
                    {wch: 20}, {wch: 20}, {wch: 25}, {wch: 20}, {wch: 25},
                    {wch: 30}, {wch: 15}, {wch: 20}, {wch: 12}, {wch: 12},
                    {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 15},
                    {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 12},
                    {wch: 12}, {wch: 15}
                ];
                ws['!cols'] = wscols;
                
                XLSX.utils.book_append_sheet(wb, ws, "Cotizaciones");
                XLSX.writeFile(wb, `cotizaciones_ifs_${new Date().toISOString().slice(0,10)}.xlsx`);
                
                mostrarAlerta('Archivo Excel generado y descargado', 'success');
                
            } catch (error) {
                mostrarAlerta('Error al exportar: ' + error.message, 'danger');
            }
        }

        function descargarRuta() {
            if (!currentRouteInfo) {
                mostrarAlerta('Primero debe trazar una ruta', 'warning');
                return;
            }
            
            // Crear informaci√≥n de la ruta para descargar
            const rutaData = {
                fecha: new Date().toLocaleString('es-PA'),
                numero: document.getElementById('numeroCotizacion').textContent,
                cliente: document.getElementById('cliente').value,
                ruta: waypoints.join(' ‚Üí '),
                distancia: currentRouteInfo.info.distanciaTotal + ' km',
                tiempo: currentRouteInfo.info.tiempoTotal + ' min',
                coordenadas: currentRouteInfo.coordenadas,
                costos: currentRouteInfo.costos,
                precios: cotizacionActual ? cotizacionActual.precios : null
            };
            
            const blob = new Blob([JSON.stringify(rutaData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ruta_${document.getElementById('cliente').value.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            mostrarAlerta('Informaci√≥n de ruta descargada en formato JSON', 'success');
        }

        // ==================== IMPRIMIR COTIZACI√ìN ====================
        function imprimirCotizacion() {
            if (!cotizacionActual) {
                mostrarAlerta('Primero debe trazar una ruta', 'warning');
                return;
            }
            
            const ventana = window.open('', '_blank');
            const fecha = new Date().toLocaleDateString('es-PA');
            const vehiculoNombre = VEHICULOS[cotizacionActual.vehiculo]?.nombre || cotizacionActual.vehiculo;
            const montoTransporte = parseFloat(document.getElementById('inputMontoTransporte').value) || 0;
            
            ventana.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Cotizaci√≥n IFS - ${cotizacionActual.cliente}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #003366; padding-bottom: 20px; }
                        h1 { color: #003366; margin: 10px 0; }
                        h2 { color: #0056b3; margin: 20px 0 10px; }
                        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background: #003366; color: white; }
                        .price-highlight { background: #28a745; color: white; padding: 20px; text-align: center; border-radius: 10px; margin: 20px 0; }
                        .monto-transporte { background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 10px; margin: 20px 0; }
                        .footer { margin-top: 40px; font-size: 12px; color: #666; text-align: center; }
                        @media print {
                            body { margin: 20px; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>INTERNATIONAL FREIGHT SERVICES (PANAM√Å) INC.</h1>
                        <h2>COTIZACI√ìN DE TRANSPORTE CON MAPA DE RUTA</h2>
                        <p><strong>N√∫mero:</strong> ${cotizacionActual.numero} | <strong>Fecha:</strong> ${fecha}</p>
                    </div>
                    
                    <div class="section">
                        <h3>INFORMACI√ìN DEL CLIENTE</h3>
                        <p><strong>Cliente:</strong> ${cotizacionActual.cliente}</p>
                        <p><strong>Contacto:</strong> ${cotizacionActual.contacto || 'No especificado'}</p>
                    </div>
                    
                    <div class="section">
                        <h3>DETALLES DE LA RUTA</h3>
                        <p><strong>Origen:</strong> ${cotizacionActual.origen}</p>
                        <p><strong>Destinos:</strong> ${cotizacionActual.destinos.join(' ‚Üí ')}</p>
                        <p><strong>Distancia total:</strong> ${cotizacionActual.infoRuta.distanciaTotal} km</p>
                        <p><strong>Tiempo estimado:</strong> ${cotizacionActual.infoRuta.tiempoTotal} minutos</p>
                    </div>
                    
                    <div class="section">
                        <h3>ESPECIFICACIONES DEL SERVICIO</h3>
                        <table>
                            <tr><th>Concepto</th><th>Detalle</th></tr>
                            <tr><td>Veh√≠culo</td><td>${vehiculoNombre}</td></tr>
                            <tr><td>N√∫mero de destinos</td><td>${cotizacionActual.destinos.length}</td></tr>
                            <tr><td>Carga</td><td>${cotizacionActual.peso} kg / ${cotizacionActual.volumen} m¬≥</td></tr>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h3>COSTOS DETALLADOS</h3>
                        <table>
                            <tr><th>Concepto</th><th>Valor (USD)</th></tr>
                            <tr><td>Combustible</td><td>$${parseFloat(cotizacionActual.costos.combustible).toFixed(2)}</td></tr>
                            <tr><td>Personal</td><td>$${parseFloat(cotizacionActual.costos.personal).toFixed(2)}</td></tr>
                            <tr><td>Vi√°ticos + Hospedaje</td><td>$${parseFloat(cotizacionActual.costos.viaticosHotel).toFixed(2)}</td></tr>
                            <tr><td>Peajes</td><td>$${parseFloat(cotizacionActual.costos.peajes).toFixed(2)}</td></tr>
                            <tr style="font-weight:bold;"><td>TOTAL COSTO BASE</td><td>$${parseFloat(cotizacionActual.costos.total).toFixed(2)}</td></tr>
                        </table>
                    </div>
                    
                    <div class="price-highlight">
                        <h3 style="margin: 0 0 10px 0;">PRECIO SUGERIDO</h3>
                        <div style="font-size: 36px; font-weight: bold;">$${cotizacionActual.precios.sugerido.toFixed(2)}</div>
                        <p>(30% markup sobre costo base)</p>
                    </div>
                    
                    <div class="monto-transporte">
                        <h3 style="margin: 0 0 10px 0; color: #856404;">MONTO DEL TRANSPORTE</h3>
                        <div style="font-size: 32px; font-weight: bold; color: #d39e00;">$${montoTransporte.toFixed(2)}</div>
                    </div>
                    
                    <div class="section">
                        <h3>OTRAS OPCIONES DE PRECIO</h3>
                        <table>
                            <tr>
                                <td><strong>Precio +25%:</strong> $${cotizacionActual.precios.precio25.toFixed(2)}</td>
                                <td><strong>Precio +35%:</strong> $${cotizacionActual.precios.precio35.toFixed(2)}</td>
                                <td><strong>Precio +40%:</strong> $${cotizacionActual.precios.precio40.toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="footer">
                        <p>Esta cotizaci√≥n es v√°lida por 30 d√≠as a partir de la fecha de emisi√≥n.</p>
                        <p>International Freight Services (Panam√°) Inc.</p>
                        <p>Parque Industrial Costa del Este ‚Äì 1¬™ Avenida ‚Äì 4to Edificio N¬∫111</p>
                        <p>Costa del Este, Corregimiento de Parque Lefevre, Panam√°</p>
                        <p>Tel: (+507) 271-6300 | Email: info@ifs-panama.com</p>
                    </div>
                    
                    <div class="no-print" style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Imprimir
                        </button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            Cerrar
                        </button>
                    </div>
                    
                    <script>
                        window.onload = function() {
                            // Auto-imprimir
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `);
            ventana.document.close();
        }

        // ==================== FUNCIONES AUXILIARES ====================
        function generarId() {
            const fecha = new Date();
            const yyyy = fecha.getFullYear();
            const mm = String(fecha.getMonth() + 1).padStart(2, '0');
            const dd = String(fecha.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `COT-${yyyy}${mm}${dd}-${random}`;
        }

        function habilitarBotones() {
            document.getElementById('btnGuardar').disabled = false;
            document.getElementById('btnWhatsApp').disabled = false;
            document.getElementById('btnImprimir').disabled = false;
            document.getElementById('btnDescargar').disabled = false;
        }

        function limpiarFormulario() {
            if (!confirm('¬øEst√° seguro de limpiar el formulario?\nSe perder√° la ruta actual no guardada.')) return;
            
            document.getElementById('cliente').value = '';
            document.getElementById('contacto').value = '';
            document.getElementById('origen').value = 'Ciudad de Panam√°';
            document.getElementById('destino1').value = '';
            document.getElementById('vehiculo').value = 'CF14';
            document.getElementById('peso').value = '0';
            document.getElementById('volumen').value = '0';
            document.getElementById('horasExtras').value = '0';
            document.getElementById('tiempoCargaDescarga').value = '1.12';
            document.getElementById('peajes').value = '0';
            document.getElementById('combustible').value = '0.85';
            document.getElementById('inputMontoTransporte').value = '0.00';
            actualizarMontoTransporte();
            
            // Limpiar vi√°ticos
            ['Desayuno', 'Almuerzo', 'Cena', 'Hotel'].forEach(item => {
                const chk = document.getElementById('chk' + item);
                const qty = document.getElementById('qty' + item);
                if (chk) chk.checked = false;
                if (qty) qty.value = '1';
            });
            calcViaticos();
            
            // Limpiar checkboxes de tipo de carga
            document.querySelectorAll('input[name="carga"]').forEach(cb => cb.checked = false);
            
            // Limpiar destinos adicionales
            const destinosContainer = document.getElementById('destinosContainer');
            while (destinosContainer.children.length > 1) {
                destinosContainer.lastChild.remove();
            }
            
            // Reiniciar controles
            document.getElementById('checkVeloPers').checked = false;
            document.getElementById('veloPersWrapper').style.display = 'none';
            document.getElementById('btnToggleVelocidad').textContent = 'üö¶ Velocidad manual: OFF';
            document.getElementById('btnToggleVelocidad').className = 'toggle-btn';
            
            document.getElementById('evitarPeajes').checked = true;
            document.getElementById('btnTogglePeaje').textContent = 'üõ£Ô∏è Sin peajes: ON';
            document.getElementById('btnTogglePeaje').className = 'toggle-btn active';
            
            // Limpiar mapa
            limpiarRuta();
            
            // Actualizar porcentaje de carga
            calcularPorcentajeCarga();
            
            mostrarAlerta('Formulario limpiado', 'success');
        }

        function mostrarLoading() {
            document.getElementById('resultadosDetalles').innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 20px; color: #007bff; font-weight: bold;">Calculando ruta y trazando en el mapa...</p>
                    <p style="color: #6c757d; font-size: 14px;">Obteniendo coordenadas y calculando distancias</p>
                </div>
            `;
        }

        function mostrarAlerta(mensaje, tipo) {
            // Crear alerta
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo}`;
            alerta.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                ${mensaje}
            `;
            
            // Insertar al inicio del contenedor principal
            const container = document.querySelector('.container');
            container.insertBefore(alerta, container.firstChild);
            
            // Auto-eliminar despu√©s de 5 segundos
            setTimeout(() => {
                if (alerta.parentNode) {
                    alerta.style.opacity = '0';
                    alerta.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        if (alerta.parentNode) {
                            alerta.parentNode.removeChild(alerta);
                        }
                    }, 500);
                }
            }, 5000);
        }

        // ==================== INICIALIZAR VALORES ====================
        // Inicializar valores de veh√≠culo
        actualizarVelocidadVehiculo();
        calcularPorcentajeCarga();
        
        // Inicializar n√∫mero de cotizaci√≥n
        if (!localStorage.getItem('correlativoCotizacionIFS')) {
            localStorage.setItem('correlativoCotizacionIFS', '1000');
        }
    </script>
</body>
</html>
